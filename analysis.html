<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Analysis Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', sans-serif;
      background: linear-gradient(135deg,#6A329F,#3B1C5B);
      color: white;
      overflow-x: hidden;
    }

    /* NAV */
    .top-nav {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 18px 24px;
      background: rgba(26,26,26,0.35);
      position: relative;
      z-index: 10;
    }
    .logo { font-size: 26px; font-weight: bold; }
    .nav-buttons { display: flex; gap: 20px; }
    .nav-buttons button {
      background: transparent;
      color: #f2f2f2;
      padding: 8px 14px;
      font-size: 16px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: 0.25s;
    }
    .nav-buttons button.active {
      background: linear-gradient(135deg,#C9A8E3,#6A329F);
      font-weight: bold;
      color: #fff;
    }
    .nav-buttons button:hover { border: 2px solid #C9A8E3; }
    .hamburger { display: none; flex-direction: column; gap: 5px; cursor: pointer; }
    .hamburger div { height: 3px; width: 28px; background: white; border-radius: 2px; }

    @media(max-width:600px) { 
      .nav-buttons { display: none; } 
      .hamburger { display: flex; } 
    }

    .mobile-menu {
      display: none;
      flex-direction: column;
      background: rgba(26,26,26,0.95);
      padding: 12px;
      position: absolute;
      left: 0;
      right: 0;
      top: 60px;
      z-index: 10;
      animation: slideDown 0.35s ease;
    }

    .mobile-menu button {
      background: transparent;
      border: none;
      font-size: 16px;
      color: white;
      padding: 14px;
      text-align: left;
    }

    .mobile-menu button.active { font-weight: bold; color: #ffd6ff; }

    @keyframes slideDown {
      from { opacity: 0.2; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* CONTENT */
    .section-wrap { padding: 0; }
    .section-title {
      margin: 20px 8px;
      font-size: 20px;
      font-weight: 600;
      color: #fff;
    }
    .section {
      display: flex;
      gap: 16px;
      overflow-x: auto;
      padding: 8px 8px 22px 8px;
    }

    .card {
      background: rgba(255,255,255,0.12);
      backdrop-filter: blur(8px);
      padding: 12px;
      border-radius: 14px;
      min-width: 260px;
      max-width: 320px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.35);
      cursor: pointer;
      transition: 0.22s;
    }
    .card:hover {
      transform: translateY(-6px);
      box-shadow: 0 10px 28px rgba(0,0,0,0.55);
    }

    .card-header {
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:8px;
    }
    .title { font-size:16px; font-weight:700; text-transform:capitalize; }
    .ids { font-size:12px; opacity:0.85; }

    .chart-container { margin-top:6px; height:150px; }
    canvas { width:100% !important; height:150px !important; }

    /* popup */
    #extraInfo {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%,-50%);
      background: rgba(18,18,18,0.96);
      color: #fff;
      border-radius: 12px;
      padding: 18px;
      z-index: 1200;
      max-width: 92%;
      max-height: 84%;
      overflow:auto;
      display:none;
      box-shadow: 0 12px 40px rgba(0,0,0,0.6);
    }
    #closeInfo {
      position:absolute;
      right:12px;
      top:10px;
      cursor:pointer;
      color:#ff6b6b;
      font-size:18px;
    }
    #infoTitle { margin:0 0 8px 0; font-weight:700; font-size:18px; text-transform:capitalize; }
    #infoContent { white-space: pre-wrap; font-size:15px; line-height:1.5; color:#e6e6e6; }

    .muted { opacity:0.8; font-size:13px; margin-top:6px; }
  </style>
</head>

<body>

  <div class="top-nav">
    <div class="logo">Voltraxx</div>
    <div class="nav-buttons">
      <button onclick="navigate('index.html', this)">Monitoring</button>
      <button class="active" onclick="navigate('analysis.html', this)">Analysis</button>
      <button onclick="navigate('history.html', this)">History</button>
      <button onclick="navigate('settings.html', this)">Settings</button>
      <button onclick="logoutUser()">Logout</button>
    </div>
    <div class="hamburger" onclick="toggleMenu()">
      <div></div><div></div><div></div>
    </div>
  </div>

  <div id="mobileMenu" class="mobile-menu">
    <button onclick="navigate('index.html', this)">Monitoring</button>
    <button class="active" onclick="navigate('analysis.html', this)">Analysis</button>
    <button onclick="navigate('history.html', this)">History</button>
    <button onclick="navigate('settings.html', this)">Settings</button>
    <button onclick="logoutUser()">Logout</button>
  </div>

  <div id="sections" class="section-wrap"></div>

  <!-- popup -->
  <div id="extraInfo">
    <span id="closeInfo" onclick="closeExtraInfo()">âœ–</span>
    <div id="infoTitle"></div>
    <div id="infoContent"></div>
  </div>

<script>
/* NAV */
function toggleMenu(){
  const m = document.getElementById('mobileMenu');
  m.style.display = (m.style.display === 'flex') ? 'none' : 'flex';
}
function navigate(page, btn){
  document.querySelectorAll('.nav-buttons button, .mobile-menu button')
    .forEach(b=>b.classList.remove('active'));
  if(btn) btn.classList.add('active');
  window.location.href = page;
}

function logoutUser() {
  sessionStorage.clear();
  window.location = "index.html";
}


/* ---------------- CONFIG ---------------- */
const BASE_URL = sessionStorage.getItem("BASE_URL");

if (!BASE_URL) {
  // If user opens monitoring.html directly without login
  alert("Session expired. Please log in again.");
  window.location = "index.html";
}

/* ---------------- FETCH ---------------- */
fetch(`${BASE_URL}?page=analysis`)
  .then(r => r.json())
  .then(json => {
    const wrapper = document.getElementById('sections');

    // custom category order
    const order = ["distance","flow","temperature"];

    // get existing API keys except status
    let keys = Object.keys(json).filter(k => k !== 'status');

    // put in order
    keys.sort((a,b)=>{
      const ai = order.indexOf(a.toLowerCase());
      const bi = order.indexOf(b.toLowerCase());
      if(ai === -1 && bi === -1) return a.localeCompare(b);
      if(ai === -1) return 1;
      if(bi === -1) return -1;
      return ai - bi;
    });

    keys.forEach(key => {
      const arr = json[key];
      if(!Array.isArray(arr) || arr.length === 0) return;

      const title = document.createElement('h2');
      title.className = 'section-title';
      title.innerText = key.charAt(0).toUpperCase() + key.slice(1);
      wrapper.appendChild(title);

      const sec = document.createElement('div');
      sec.className = 'section';
      wrapper.appendChild(sec);

      arr.forEach(sensor => sec.appendChild(createCard(sensor)));
    });
  })
  .catch(err => {
    console.error('fetch error', err);
    document.getElementById('sections').innerHTML =
      '<div class="muted">Could not load data from API.</div>';
  });

/* ---------------- CARD ---------------- */
function createCard(item){
  const card = document.createElement('div');
  card.className = 'card';

  const labelText = (item.Label && item.Label != -1) ? item.Label : '';
  const cID = item["controller ID"] ?? '';
  const sID = item["sensor ID"] ?? '';
  const cSID = `C${cID}:S${sID}`;

  const header = document.createElement('div');
  header.className = 'card-header';
  const t = document.createElement('div');
  t.className = 'title';
  t.innerText = labelText || `Sensor ${cSID}`;
  const ids = document.createElement('div');
  ids.className = 'ids';
  ids.innerText = cSID;
  header.appendChild(t);
  header.appendChild(ids);
  card.appendChild(header);

  const chartWrap = document.createElement('div');
  chartWrap.className = 'chart-container';
  const canvas = document.createElement('canvas');
  chartWrap.appendChild(canvas);
  card.appendChild(chartWrap);

  renderChart(canvas, item);
  card.onclick = () => openPopup(item);

  return card;
}

/* ---------------- GRAPH ---------------- */
function renderChart(canvas, item){
  const labels = Array.from({length:24}, (_,i)=> String(i));

  // preserve empty and -1
  let rawValues = labels.map(key => {
    const v = item[key];
    if (v === -1 || v === "" || v === null || v === undefined) return null;
    return Number(v);
  });

  // apply percentage ONLY to Distance
  if(item["Sensor Type"] === "Distance"){
    const H = Number(item["Tank Height"]) || 0;
    const O = Number(item["Offset Error"]) || 0;

    if(H > 0){
      rawValues = rawValues.map(v => {
        if(v === null) return null;
        const pct = ((H - v + O) / H) * 100;
        return Math.max(0, Math.min(100, Math.round(pct)));
      });
    }
  }

  new Chart(canvas.getContext('2d'), {
    type: 'bar',
    data: {
      labels,
      datasets: [{
        data: rawValues,
        skipNull: true,
        spanGaps: false,
        backgroundColor: '#e69df4',
        borderRadius: 6
      }]
    },
    options: {
      plugins: { legend:{display:false} },
      scales: {
        x:{ ticks:{color:'#fff'}, grid:{display:false}},
        y:{ ticks:{color:'#fff'}, grid:{color:'rgba(255,255,255,0.06)'}}
      },
      maintainAspectRatio:false
    }
  });
}

/* ---------------- POPUP ---------------- */
function openPopup(item){
  const cID = item["controller ID"];
  const sID = item["sensor ID"];
  const title = (item.Label && item.Label != -1)
      ? `${item.Label} C${cID}:S${sID}`
      : `Sensor C${cID}:S${sID}`;

  document.getElementById('infoTitle').innerText = title;

  let lines = [];

  const add = (label,key)=>{
    const v = item[key];
    if(v !== undefined && v !== -1 && v !== "" && v !== null){
      lines.push(`${label}: ${v}`);
    }
  };

  add("Tank Volume","Tank Volume");
  add("Tank Height","Tank Height");
  add("Offset Error","Offset Error");

  for(let i=1;i<=5;i++){
    const ck = `custom ${i}`;
    const vk = `value ${i}`;
    if(item[ck] !== -1 && item[ck] !== ""
    && item[vk] !== -1 && item[vk] !== ""){
      lines.push(`${item[ck]}: ${item[vk]}`);
    }
  }

  if(lines.length === 0) lines.push("(no extra info)");

  document.getElementById('infoContent').innerText = lines.join("\n");
  document.getElementById('extraInfo').style.display = 'block';
}
function closeExtraInfo(){
  document.getElementById('extraInfo').style.display = 'none';
}
</script>

</body>
</html>
