<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>History Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body{
      margin:0;
      padding:0;
      font-family:'Segoe UI',sans-serif;
      background:linear-gradient(135deg,#6A329F,#3B1C5B);
      color:white;
    }

    /* NAVIGATION */
    .top-nav{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:18px 24px;
      background:rgba(26,26,26,0.35);
      position: relative;
      z-index: 1000;
      height: 60px;
    }
    .logo{font-size:26px;font-weight:700;}

    .nav-buttons{display:flex;gap:20px;}
    .nav-buttons button{
      background:transparent;color:#fff;
      padding:8px 14px;font-size:16px;
      border:none;border-radius:6px;
      cursor:pointer;transition:.25s;
    }
    .nav-buttons button.active{
      background:linear-gradient(135deg,#C9A8E3,#6A329F);
      color:#fff;font-weight:700;
    }
    .nav-buttons button:hover{
      border:2px solid #C9A8E3;
    }

    /* HAMBURGER */
    .hamburger{
      display:none;
      flex-direction:column;
      gap:5px;
      cursor:pointer;
    }
    .hamburger div{
      height:3px;width:28px;background:white;border-radius:2px;
    }
    .mobile-menu{
      display:none;
      flex-direction:column;
      background:rgba(26,26,26,0.95);
      padding:12px;
      position:absolute;
      left:0;right:0;top:90px;
      z-index:6000; /* ABOVE LOADING SCREEN */
    }
    .mobile-menu button{
      background:transparent;border:none;font-size:16px;
      color:white;padding:14px;text-align:left;
    }
    .mobile-menu button.active{
      font-weight:bold;color:#ffd6ff;
    }

    @media(max-width:600px){
      .nav-buttons{display:none;}
      .hamburger{display:flex;}
    }

    /* FILTERS */
    .filters{
      padding:14px;
      display:flex;
      justify-content:center;
      gap:12px;
      flex-wrap:wrap;
    }
    select,input[type="date"],button.fetchBtn{
      padding:10px;font-size:15px;border-radius:8px;border:none;
    }

    /* BUTTON STATES */
    button.fetchBtn{
      background:#C9A8E3;
      color:#111;
      font-weight:600;
      cursor:pointer;
      transition:0.3s;
    }
    button.fetchBtn.loading{
      background:#ffca2c;
      color:#111;
    }
    button.fetchBtn.success{
      background:#17c964;
      color:white;
    }
    button.fetchBtn.error{
      background:#ff4d4f;
      color:white;
    }

    /* DOWNLOAD BUTTON */
    .download-wrap{
      display:none;
      justify-content:center;
      margin:12px 0 30px;
    }
    button.downloadBtn{
      background:#00b7ff;
      color:#111;
      padding:10px 18px;
      border:none;
      border-radius:8px;
      font-size:16px;
      font-weight:600;
      cursor:pointer;
      transition:0.35s;
    }

    /* CONTAINERS */
    .section-wrap{
      padding:20px;
      display:flex;
      flex-direction:column;
      gap:22px;
      max-width:900px;
      margin:auto;
    }
    .card{
      background:rgba(255,255,255,0.12);
      backdrop-filter:blur(8px);
      border-radius:14px;
      padding:16px;
      box-shadow:0 6px 20px rgba(0,0,0,0.35);
    }
    .title{font-size:18px;font-weight:700;}
    .subtitle{opacity:.85;margin-bottom:10px;}

    /* GRAPH */
    .chart-container{
      width:100%;
      margin-top:6px;
      height:180px;
    }

    canvas{
      width:100%!important;
      height:180px!important;
    }

    @media(min-width:768px){
      .chart-container{ height:340px; }
      canvas{ height:340px!important; }
    }

    /* TABLE */
    table{
      width:100%;
      border-collapse:collapse;
      margin-top:10px;
      font-size:15px;
    }
    td{
      padding:8px 4px;
      border-bottom:1px solid rgba(255,255,255,0.14);
    }
    td:first-child{
      opacity:.85;
      width:42%;
      font-weight:500;
    }

    /* ---------- LOADING SCREEN (NAV visible) ---------- */
    #loadingScreen {
      position: fixed;
      top: 90px;   /* navbar height */
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(20,20,20,0.92);
      backdrop-filter: blur(4px);
      display: flex;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      z-index: 5000;
      color: white;
      font-family: 'Segoe UI', sans-serif;
    }
    .loader {
      width: 55px;
      height: 55px;
      border: 5px solid #ffffff55;
      border-top-color: #C9A8E3;
      border-radius: 50%;
      animation: spin .9s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

  </style>
</head>

<body>

<!-- LOADING SCREEN -->
<div id="loadingScreen">
  <div class="loader"></div>
  <p>Loading...</p>
</div>

<script>
function hideLoader(){
  let l = document.getElementById("loadingScreen");
  if(l) l.style.display = "none";
}
</script>

<!-- NAV -->
<div class="top-nav">
  <div class="logo">Voltraxx</div>

  <div class="nav-buttons">
    <button onclick="nav('monitoring.html')">Monitoring</button>
    <button onclick="nav('analysis.html')">Analysis</button>
    <button class="active" onclick="nav('history.html')">History</button>
    <button onclick="nav('settings.html')">Settings</button>
    <button onclick="logoutUser()">Logout</button>
  </div>

  <div class="hamburger" onclick="toggleMenu()">
    <div></div><div></div><div></div>
  </div>
</div>

<div id="mobileMenu" class="mobile-menu">
  <button onclick="nav('monitoring.html')">Monitoring</button>
  <button onclick="nav('analysis.html')">Analysis</button>
  <button class="active" onclick="nav('history.html')">History</button>
  <button onclick="nav('settings.html')">Settings</button>
  <button onclick="logoutUser()">Logout</button>
</div>

<!-- FILTER -->
<div class="filters">
  <select id="sensorSelect">
    <option value="">Select Sensor</option>
  </select>
  <input type="date" id="dateSelect">
  <button class="fetchBtn" onclick="getHistory()">Fetch</button>
</div>

<div id="sections" class="section-wrap"></div>

<!-- DOWNLOAD -->
<div class="download-wrap" id="downloadBlock">
  <button class="downloadBtn" onclick="downloadJPEG()">⬇ Download Graph + Table</button>
</div>


<script>
function nav(p){window.location.href=p;}
function toggleMenu(){
  let m=document.getElementById("mobileMenu");
  m.style.display=m.style.display==="flex"?"none":"flex";
}

function logoutUser() {
  sessionStorage.clear();
  window.location = "index.html";
}

const BASE_URL = sessionStorage.getItem("BASE_URL");

if (!BASE_URL) {
  alert("Session expired. Please log in again.");
  window.location = "index.html";
}

let lastRow=null;


/******** INITIAL SENSOR LIST *********/
window.onload=()=>{
  fetch(`${BASE_URL}?page=history`)
  .then(r=>r.json())
  .then(j=>{
    hideLoader();  // ✔ remove loader after initial load

    const sel=document.getElementById("sensorSelect");
    if(j.AvailableSensors){
      j.AvailableSensors.forEach(id=>{
        const o=document.createElement("option");
        o.value=id;
        o.innerText=`Sensor ${id}`;
        sel.appendChild(o);
      });
    }
  })
  .catch(()=>hideLoader());
};


/******** FETCH DATA *********/
function getHistory(){
  hideLoader(); // in case user clicks again

  const btn=document.querySelector(".fetchBtn");
  btn.classList.remove("success","error");
  btn.classList.add("loading");
  btn.innerText="Loading...";

  const s=document.getElementById("sensorSelect").value;
  const d=document.getElementById("dateSelect").value;

  if(!s||!d){
    btn.classList.remove("loading");
    btn.classList.add("error");
    btn.innerText="Select Both";
    return;
  }

  const p=d.split("-");
  const final=`${p[2]}/${p[1]}/${p[0]}`;

  fetch(`${BASE_URL}?page=history&sensorid=${s}&date=${final}`)
  .then(r=>r.json())
  .then(j=>{
    if(j.status!=="ok"){fail(); return;}

    lastRow=j.row;
    renderHistory(j.row);

    btn.classList.remove("loading");
    btn.classList.add("success");
    btn.innerText="Fetched ✔";

    document.getElementById("downloadBlock").style.display="flex";

    hideLoader();  // ✔ remove loader after fetch
  })
  .catch(fail);

  function fail(){
    btn.classList.remove("loading");
    btn.classList.add("error");
    btn.innerText="Error";
    hideLoader();
  }
}


/******** RENDER *********/
function renderHistory(item){
  const wrap=document.getElementById("sections");
  wrap.innerHTML="";

  wrap.appendChild(graphCard(item));
  wrap.appendChild(tableCard(item));
}


/******** GRAPH CARD *********/
function graphCard(item){
  const card=document.createElement("div");
  card.className="card";

  const head=document.createElement("div");
  head.className="title";
  head.innerText = (item.Label && item.Label!=-1)
    ? item.Label
    : `Sensor C${item["controller ID"]}:S${item["sensor ID"]}`;
  card.appendChild(head);

  const sub=document.createElement("div");
  sub.className="subtitle";
  sub.innerText=item.date;
  card.appendChild(sub);

  const cc=document.createElement("div");
  cc.className="chart-container";
  const c=document.createElement("canvas");
  cc.appendChild(c);
  card.appendChild(cc);

  renderChart(c,item);
  return card;
}


/******** TABLE CARD *********/
function tableCard(item){
  const card=document.createElement("div");
  card.className="card";

  const head=document.createElement("div");
  head.className="title";
  head.innerText="Sensor Details";
  card.appendChild(head);

  const t=document.createElement("table");

  const skip=[
    "readings","Main data","Sub data",
    ...Array.from({length:24},(_,i)=>String(i))
  ];

  const add=(k,v)=>{
    const tr=document.createElement("tr");
    const td1=document.createElement("td");
    const td2=document.createElement("td");
    td1.innerText=k;
    td2.innerText=v;
    tr.appendChild(td1);
    tr.appendChild(td2);
    t.appendChild(tr);
  }

  const empty=v=>v===-1||v===""||v===null;

  for(const k in item){
    if(skip.includes(k))continue;
    if(!isNaN(k))continue;
    if(empty(item[k]))continue;
    add(k,item[k]);
  }
  for(let i=1;i<=5;i++){
    let c=item[`custom ${i}`];
    let v=item[`value ${i}`];
    if(!empty(c)&&!empty(v))add(c,v);
  }

  card.appendChild(t);
  return card;
}


/******** GRAPH BUILD *********/
function renderChart(canvas,item){
  const labels=Array.from({length:24},(_,i)=>i);
  let values=labels.map(i=>{
    const v=item[String(i)];
    if(v===-1||v===""||v==null)return null;
    return Number(v);
  });

  if(item["Sensor Type"]==="Distance"){
    const H=Number(item["Tank Height"]);
    const O=Number(item["Offset Error"]);
    if(H>0){
      values=values.map(v=>{
        if(v===null)return null;
        return Math.max(0,Math.min(100,Math.round(((H-v+O)/H)*100)));
      });
    }
  }

  new Chart(canvas.getContext("2d"),{
    type:"bar",
    data:{
      labels,
      datasets:[{
        data:values,
        backgroundColor:"#e69df4",
        borderRadius:6
      }]
    },
    options:{
      plugins:{legend:{display:false}},
      scales:{
        x:{ticks:{color:'#fff'},grid:{display:false}},
        y:{ticks:{color:'#fff'}}
      },
      maintainAspectRatio:false
    }
  });
}


/******** COMBINE GRAPH + TABLE AS JPEG *********/
function downloadJPEG(){

  const graphCanvas = document.querySelector("canvas");
  const table = document.querySelector("table");

  if(!graphCanvas || !table){
    alert("Missing graph or table");
    return;
  }

  const rows = [...table.rows].map(r => [...r.cells].map(c => c.innerText));

  const w = 1000;
  const logoHeight = 90;
  const spacing = 40;
  const tableHeight = rows.length * 38;
  const graphH = graphCanvas.height;

  const h = logoHeight + spacing + graphH + spacing + tableHeight + 100;

  const out = document.createElement("canvas");
  out.width = w;
  out.height = h;
  const ctx = out.getContext("2d");

  ctx.fillStyle = "#222233";
  ctx.fillRect(0, 0, w, h);

  ctx.fillStyle = "#ffffff";
  ctx.font = "32px Segoe UI";
  ctx.textAlign = "center";
  ctx.fillText("VOLTRAXX", w / 2, 60);

  ctx.drawImage(graphCanvas, 50, logoHeight + 20, 900, graphH);

  ctx.textAlign = "left";
  ctx.font = "18px Segoe UI";
  ctx.fillStyle = "#fff";

  let y = logoHeight + 20 + graphH + 40;

  for (const r of rows) {
    ctx.fillText(`${r[0]}: ${r[1]}`, 60, y);
    y += 34;
  }

  const a = document.createElement("a");
  a.download = "history_export.jpeg";
  a.href = out.toDataURL("image/jpeg", 0.95);
  a.click();
}

</script>

</body>
</html>
