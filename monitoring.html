<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Monitoring Dashboard</title>

  <style>
    body{
      margin:0;
      padding:0;
      font-family:'Segoe UI',sans-serif;
      background:linear-gradient(135deg,#6A329F,#3B1C5B);
      color:white;
      overflow-x:hidden;
    }

    /* ---------- NAV ---------- */
    .top-nav{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:18px 24px;
      background:rgba(26,26,26,0.35);
      position:relative;
      z-index:1000; /* âœ” brings nav above cards */
    }
    .logo{font-size:26px;font-weight:700;}

    .nav-buttons{display:flex;gap:20px;}
    .nav-buttons button{
      background:transparent;
      color:#fff;
      padding:8px 14px;
      font-size:16px;
      border:none;
      border-radius:6px;
      cursor:pointer;
      transition:.25s;
    }
    .nav-buttons button.active{
      background:linear-gradient(135deg,#C9A8E3,#6A329F);
      font-weight:700;
      color:#fff;
    }
    .nav-buttons button:hover{
      border:2px solid #C9A8E3;
    }

    .hamburger{
      display:none;
      flex-direction:column;
      gap:5px;
      cursor:pointer;
    }
    .hamburger div{
      width:28px;height:3px;background:white;border-radius:2px;
    }

    @media(max-width:600px){
      .nav-buttons{display:none;}
      .hamburger{display:flex;}
    }

    /* ---------- MOBILE MENU ---------- */
    .mobile-menu{
      display:none;
      flex-direction:column;
      background:rgba(26,26,26,0.95);
      padding:12px;
      position:absolute;
      left:0;
      right:0;
      top:60px;
      z-index:2000;  /* âœ” ON TOP of cards */
    }
    .mobile-menu button{
      background:transparent;
      border:none;
      font-size:16px;
      color:white;
      padding:14px;
      text-align:left;
    }
    .mobile-menu button.active{
      color:#ffd6ff;
      font-weight:bold;
    }

    /* ---------- CONTENT ---------- */
    .section-title{
      margin:18px 10px;
      font-size:20px;
      font-weight:600;
    }
    .section{
      display:flex;
      gap:16px;
      overflow-x:auto;
      padding:8px 10px 20px;
    }

    .card{
      background:rgba(255,255,255,0.12);
      backdrop-filter:blur(8px);
      padding:14px;
      border-radius:14px;
      min-width:260px;
      max-width:310px;
      box-shadow:0 6px 20px rgba(0,0,0,0.35);
      transition:.25s;
    }
    .card:hover{
      transform:translateY(-5px);
      box-shadow:0 10px 28px rgba(0,0,0,0.55);
    }

    .card-header{
      display:flex;
      justify-content:space-between;
      margin-bottom:6px;
    }

    .title{
      font-size:16px;
      font-weight:700;
      text-transform:capitalize;
    }
    .ids{
      font-size:12px;
      opacity:.85;
    }

    .main-line{
      display:flex;
      justify-content:space-between;
      margin-top:8px;
    }
    .main-label{font-size:14px;color:#ffd6ff;}
    .main-value{font-size:28px;font-weight:700;}

    .sub-line{
      display:flex;
      justify-content:space-between;
      margin-top:6px;
    }
    .sub-label{font-size:13px;opacity:.85;}
    .sub-value{font-size:16px;font-weight:600;}
  </style>
</head>

<body>

<!-- NAV -->
<div class="top-nav">
  <div class="logo">Voltraxx</div>

  <div class="nav-buttons">
    <button class="active" onclick="navigate('index.html',this)">Monitoring</button>
    <button onclick="navigate('analysis.html',this)">Analysis</button>
    <button onclick="navigate('history.html',this)">History</button>
    <button onclick="navigate('settings.html',this)">Settings</button>
    <button onclick="logoutUser()">Logout</button>
  </div>

  <div class="hamburger" onclick="toggleMenu()">
    <div></div><div></div><div></div>
  </div>
</div>

<!-- MOBILE MENU -->
<div id="mobileMenu" class="mobile-menu">
  <button class="active" onclick="navigate('index.html',this)">Monitoring</button>
  <button onclick="navigate('analysis.html',this)">Analysis</button>
  <button onclick="navigate('history.html',this)">History</button>
  <button onclick="navigate('settings.html',this)">Settings</button>
  <button onclick="logoutUser()">Logout</button>
</div>

<!-- CONTENT SECTIONS -->
<div class="section-wrap">

  <h2 class="section-title">Distance</h2>
  <div class="section" id="distance"></div>

  <h2 class="section-title">Flow</h2>
  <div class="section" id="flow"></div>

  <h2 class="section-title">Temperature</h2>
  <div class="section" id="temperature"></div>

  <h2 class="section-title">None</h2>
  <div class="section" id="none"></div>

</div>

<script>
/* ------------ NAVIGATION ------------ */
function toggleMenu(){
  const m=document.getElementById('mobileMenu');
  m.style.display=(m.style.display==='flex')?'none':'flex';
}
function navigate(page,btn){
  document.querySelectorAll('.nav-buttons button,.mobile-menu button')
    .forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  window.location.href=page;
}

function logoutUser() {
  sessionStorage.clear();
  window.location = "index.html";
}


/* ------------ API ------------ */
const BASE_URL = sessionStorage.getItem("BASE_URL");

if (!BASE_URL) {
  // If user opens monitoring.html directly without login
  alert("Session expired. Please log in again.");
  window.location = "index.html";
}

let cards={};
let lastSet={};

loadData();
setInterval(loadData,600);

/* ------------ FETCH ------------ */
function loadData(){
  fetch(`${BASE_URL}?page=monitoring`)
    .then(r=>r.json())
    .then(data=>{
      renderCategory("distance",data.distance||[]);
      renderCategory("flow",data.flow||[]);
      renderCategory("temperature",data.temperature||[]);
      renderCategory("none",data.none||[]);
    })
    .catch(err=>console.log(err));
}

/* ------------ BUILD CARDS ------------ */
function renderCategory(sectionID, array){
  const container = document.getElementById(sectionID);

  if(!cards[sectionID]) cards[sectionID]={};
  if(!lastSet[sectionID]) lastSet[sectionID]={};

  // clear old cards first
  container.innerHTML = "";
  cards[sectionID] = {};

  array.forEach(item => {

    // ðŸ”¥ Skip if mainData is empty or invalid
    if(
      item.mainData === "" ||
      item.mainData === null ||
      item.mainData === undefined ||
      item.mainData === "-" ||
      (typeof item.mainData === "string" && item.mainData.trim().length === 0)
    ){
      return;
    }

    const key=`${item.controllerID}-${item.sensorID}`;

    // create card
    const card=document.createElement("div");
    card.className="card";
    card.innerHTML=`
      <div class="card-header">
        <div class="title"></div>
        <div class="ids"></div>
      </div>

      <div class="main-line">
        <div class="main-label"></div>
        <div class="main-value"></div>
      </div>

      <div class="sub-line">
        <div class="sub-label"></div>
        <div class="sub-value"></div>
      </div>
    `;
    container.appendChild(card);

    cards[sectionID][key] = {
      el:card,
      title: card.querySelector(".title"),
      ids: card.querySelector(".ids"),
      mainLabel: card.querySelector(".main-label"),
      mainValue: card.querySelector(".main-value"),
      subLabel: card.querySelector(".sub-label"),
      subValue: card.querySelector(".sub-value"),
    };

    const c=cards[sectionID][key];

    const cID=item.controllerID;
    const sID=item.sensorID;
    const label=item.label;

    // Title
    if(label && label !== ""){
      c.title.innerText = label;
    } else {
      c.title.innerText = `Sensor C${cID}:S${sID}`;
    }

    c.ids.innerText = `C${cID}:S${sID}`;

    c.mainLabel.innerText = item.mainLabel||"";
    c.mainValue.innerText = `${item.mainData}${item.mainUnit||""}`;

    c.subLabel.innerText = item.subLabel||"";
    c.subValue.innerText =
      (item.subData!="" && item.subData!=null)
        ? `${item.subData}${item.subUnit||""}`
        : "";

    // ---- Border alert ----
    let color="#e69df4";
    if(item.high && item.mainData>item.high) color="#ff4d4f";
    else if(item.low && item.mainData<item.low) color="#17c964";

    c.el.style.borderLeft=`6px solid ${color}`;
  });
}
</script>
</body>
</html>
